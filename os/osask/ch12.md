# **定时器** #
***


## **1. 使用定时器** ##
    1) 定时器, 即是每隔一段时间向CPU发送一个中断信号
    2) 如果没有定时器, 就不能使用hlt指令, 因为完成这个指令所需要的时钟周期不
       是一个固定的值; 一旦执行hlt程序就不知道时间了
    3) 有了定时器, 只需要在中断处理程序中计算定时器中断发生的次数就可以知道
       时间了;
    4) 要管理定时器, 只需要对PIT(programmable interval timer)进行设定就可以
       了; 可以设置PIT让定时器每隔多少秒就发生一次中断; 
    5) PIT连接着IRQ0, 所以只要设定了PIT就可以设定IRQ0的中断间隔了
    6) IRQ0的中断周期变更:
        * al=0x34; out(0x43, al);
        * al=中断周期的低8位; out(0x40, al)
        * al=中断周期的高8位; out(0x40, al)
        * 如果指定中断周期为0, 则会被看做是65536; 实际的中断产生的频率是单位
          时间时钟周期(主频)/设定的数值; 如果设定值是11932, 中断产生的频率大
          约是100Hz, 也就是每10ms发生一次中断
          (11932 -> 0x2e9c)
    7) 具体例子请参见./os-src/toyos54/


## **2. 计量时间** ##
    1) 在timer中断中设置一个计量器, 没发生一次中断就增加1 
    2) 这样我们就可以以此来计量时间了, 将这个数值显示到窗口上(100次/秒)
    3) 具体例子请参见./os-src/toyos55/


## **3. 超时功能** ##
    1) 超时功能, 即是要操作系统过多少时间之后通知用户, 以便用户干xxx事情
    2) 在设置超时的时候, 如果设定还没有完全结束, IRQ0的中断就进来的话, 会引
       起混乱, 因此我们应该先禁止中断, 然后完成设定后在恢复中断
    3) 具体例子请参见./os-src/toyos56/


## **4. 设定多个定时器** ##
    1) 既然成功设置了一个定时器, 那我们就可以实现多个定时器
    2) 具体例子请参见./os-src/toyos57/


## **5. 加快中断处理** ##
    1) 我们看到timer中的中断处理函数, 因为会对所有的定时器进行减1操作, CPU要
       完成从内存中读取变量的值, 减去1, 然后再往内存中写; 这样操作就变多了, 
       从而影响了性能
    2) 我们只需要修改timeout的含义, 让它表示设定的时间即可, 让计数到count中
       去处理, 所以只要将timeout和count比较就可以了
    3) 因为count是unsigned int类型的, 所以当数值达到0xffffffff后就不能在设置
       更大的值了; 
    4) 具体例子请参见./os-src/toyos58/



## **6. 加快中断处理** ##
    1) 我们看到timer的中断处理函数中, 每一次都会执行500次, 而每一次的判断却
       要两个if都为真的情况才能进行
    2) 超时的情况多种多样, 那我们就应该首先关注超时时间短的那一个, 因此我们
       需要一个特殊的变量来记录下一个应该执行的超时
    3) 具体例子请参见./os-src/toyos59/



## **7. 加快中断处理** ##
    1) 现在timer中断处理中, 到达了next时刻和没有到达next时刻的中断处理的差异
       很大
    2) 应该让到达next时刻的定时器中断处理更快速一些, 这里我们可以模仿layer中
       的做法, 添加一个timers的映射, 其中存放按某种顺序排列好的定时器地址
    3) 具体例子请参见./os-src/toyos60/
