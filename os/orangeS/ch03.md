# **保护模式** #
***


## **1. 认识保护模式** ##
    1) 先来直观的看一个实模式切换到保护模式的例子
    2) 具体例子请参见./os-src/os02/
    3) 这个例子中, 我们做了如下操作:
        * 定义了一个GDT的数据结构, GdtLen是GDT的长度, GdtPtr是一个小的数据结
          构(6字节, 前2字节是GDT的界限, 后面4字节是基地址)
        * 16位代码进行了一些与GDT相关的操作
        * 32位代码进行了一点操作显存的工作
> ### **1.1 保护模式运行环境** ###
    1) 引导扇区空间有限, 只有512字节, 如果我们的程序越来越大超过512字节就不
       好办了, 那可以使用如下方法解决
        * 写一个引导扇区, 可以读取我们的程序并运行;
        * 把程序编译成COM文件, 然后让DOS来执行
    2) 操作步骤如下:
        * 下载一个FreeDos, 解压后将其中的a.img拷贝到我们的工作目录, 更名为
          freedos.img
        * bximage生成一个名为pm.img的软盘映像
        * 修改bochsrc文件, 确保有如下3行:
          floppya: 1_44=freedos.img, status=inserted
          floppyb: 1_44=pm.img, status=inserted
          boot: a
        * 启动bochs, 待freedos启动完毕后格式化B:盘
        * 将代码中的org 07c00h修改为0100h, 并重新编译
          $ nasm -o pmtest1.com pmtest1.s
        * 将pmtest1.com复制到虚拟软盘pm.img上
          $ sudo mount -o loop pm.img /mnt/floppy 
          $ sudo cp pmtest1.com /mnt/floppy/
          $ sudo umount /mnt/floppy 
        * 在FreeDos中执行命令
          > B:\pmtest1.com 
    3) 具体例子请参见./os-src/os03/
> ### **1.2 GDT(Global Descriptor Table)** ###
    1) I32下, CPU有实模式和保护模式两中工作模式
    2) 开始时CPU工作在实模式, 经过某种机制之后才进入保护模式
    3) 保护模式下, CPU具有巨大的寻址能力, 并为强大的32位系统提供了更好的硬件
       保护 
    4) Intel 8086是16位CPU, 具有16位寄存器, 16位数据总线, 20位的地址总线
    5) 物理地址 = 段值 * 16 + 偏移
    6) 在实模式下, 段值被看作是地址的一部分, 段值xxxxh表示以xxxx0h开始的一段
       内存; 在保护模式下, 虽然段值仍然是由原来16位的cs, ds等寄存器表示, 但
       此时它仅仅是一个索引, 这个索引指向一个数据结构的一个表项, 表项中详细
       定义了段的起始地址, 界限, 属性等内容;
    7) GDT的作用是用来提供段式存储机制 
    8) SelectorVideo是选择子, 是一个如下结构
       |15|14|13|12|11|10|9|8|7|6|5|4|3| 2 |1|0|
       -----------------------------------------
       |       描述符索引              |TI |RPL|
       -----------------------------------------
       当TI和RPL都为0时, 选择子就表示描述符相对GDT基址的偏移, 否则是如上结构
> 
