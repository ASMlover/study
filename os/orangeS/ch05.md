# **内核雏形** #
***



## **1. 在Linux下用汇编写Hello world** ##
    1) NASM选项"-f elf"指定输出的文件为elf格式
    2) 链接选项-s表示strip, 可以去掉符号表等内容, 起到减小可执行程序的目的
    3) 具体例子请参见./os-src/os19/ 




## **2. 汇编和C一同使用** ##
    1) 在C语言中调用了汇编编写的函数, 所以需要使用global来导出
    2) 汇编中使用了C语言中实现的函数, 所以需要使用extern来声明
    3) 不管是C语言还是汇编中的函数都遵守了C调用约定, 后面的参数先入栈, 并且
       由调用者来清理堆栈
    4) 具体例子请参见./os-src/os1a/




## **3. ELF(Executable and Linkable Format)** ##
    1) ELF文件的大体结构请参见./pic/ELF.png
    2) ELF由4部分组成:
        * ELF头(ELF header)
        * 程序头表(Program header table)
        * 节(Sections)
        * 节头表(Sections header table)
        并非每个文件都由这4部分组成, 只有ELF头的位置是固定的, 其他部分的位置
        大小等信息由ELF头来指定
    3) ELF header的结构请参见./pic/elf_header.jpg
       ELF header中各项的意义:
        * e_ident: 包含了用以表示ELF文件的字符, 以及其他一些与机器无关的信息
        * e_type: 标示该文件的类型
        * e_machine: 表明运行该程序需要的CPU体系结构(Intel 80386)
        * e_version: 确定文件的版本
        * e_entry: 程序的入口地址
        * e_phoff: Program header table在文件中的偏移量(以字节计算)
        * e_shoff: Section header table在文件中的偏移量(以字节计算)
        * e_flags: 对IA32而言, 此项为0
        * e_ehsize: ELF header的大小(以字节计算)
        * e_phentsize: Program header table中每一个条目(一个Program header)
          的大小 
        * e_phnum: Program header table中有多少个条目
        * e_shentsize: Section header table中每一个条目(一个Section header)
          的大小
        * e_shnum: Section header table中有多少个条目 
        * e_shstrndx: 包含节名称的字符串表是第几个节(从0开始) 
    4) ELF Program header的结构请参见./pic/elf_program_header.jpg 
       它描述的是系统准备程序运行所需的一个段或其他信息, 它各项的意义如下:
        * p_type: 当前Program header所描述的段的类型
        * p_offset: 段的第一个字节在文件中的偏移
        * p_vaddr: 段的第一个字节在内存中的虚拟地址
        * p_paddr: 在物理地址定位相关的系统中, 此项为物理地址保留
        * p_filesz: 段在文件中的长度
        * p_memsz: 段在内存中的长度
        * p_flags: 与段相关的标志
        * p_align: 根据此项值来确定段在文件以及内存中如何对齐 






## **4. 从Loader到内核** ##
    1) Loader需要做两项工作:
        * 加载内核到内存
        * 跳转到保护模式
