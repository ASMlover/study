# **让操作系统走进保护模式** #
***



## **1. 突破512字节的限制** ##
    1) 一个操作系统从开机到开始运行, 大致如下:
       引导->加载内核到内存->跳入保护模式->开始执行内核
       所以我们应该让引导扇区将loader加载到内存并将控制权交给loader, 其他的
       工作就交给loader来完成了, 因为loader没有512字节的限制 
> ### **1.1 FAT12** ###
    1) 是DOS时代就开始使用的文件系统; 所有的文件系统都会将磁盘划分为若干层次
       以方便组织和管理, 这些层次包括:
        * 扇区(Sector): 磁盘上的最小数据单元
        * 簇(Cluster): 一个或多个扇区
        * 分区(Partition): 通常指整个文件系统
    2) 引导扇区是整个软盘的第0个扇区, 在这个扇区中有一个很重要的数据结构叫做
       BPB(BIOS Parameter Block), 以BPB_开头的属于BPB, 以BS_开头的不属于BPB,
       只是引导扇区的一部分
       详情请参见./pic/boot-sector-structure.jpg
    3) 引导扇区后面是两个完全相同的FAT表, 每个表占用9个扇区, 第二个FAT之后是
       根目录区的第一个扇区; 根目录区后面是数据区
       详情请参见./pic/FAT12.jpg 
    4) 我们假定loader只能放在根目录区, 根目录区详情请参见./pic/root-dir.png
        * 位于第二个FAT表之后, 开始的扇区号为19, 由若干个目录条目组成, 条目
          最多BPB_RootEntCnt个; 根目录区大小依赖与BPB_RootEntCnt, 所以长度是
          不固定的
        * 根目录区的每一个条目占32字节 
    5) FAT表
        * 每12位为一个FAT项(FAT Entry), 代表一个簇
        * 第0个和第1个FAT项始终不使用, 从第二个FAT项开始表示数据区每一个簇 
        * 由于每个FAT项12位比较别扭, 实际情况是每3个字节来看
        * FAT项的值代表的是下一个簇号, 如果值>=0xff8, 表示当前簇已经是本文件
          的最后一个簇了; 如果是0xff7, 表示是一个坏的簇 
        * 一个FAT项可能会跨越2个扇区 
> ### **1.2 DOS可以识别的引导盘** ###
    1) 引导扇区需要有BPB等头信息才能被识别 
    2) 具体例子请参见./os-src/os13/
> ### **1.3 一个最简单的Loader** ###
    1) 系统需要将loader加载到内存, 我们先写一个最简单的loader 
    2) 具体例子请参见./os-src/os14/
> ### **1.4 加载loader到内存** ###
    1) BIOS中断int 13用法:
        Interrupt |       register                    | effect
        -----------------------------------------------------------------
         13h      | ah=00h          dl=driver number  | 复位软驱
                  -------------------------------------------------------
                  | ah=02h          al=sector number  | 从磁盘将数据读如
                  | ch=cylinder     al=start sector No| es:bx指向的缓冲区
                  | dh=disk header  dl=driver number  |
                  | es:bx->data buffer                | 
        -----------------------------------------------------------------
    2) 软盘有2个柱面(磁头号0和1), 每个面有80个磁道(0~79), 每个磁道有18个扇区
       (1~18):
       2 * 80 * 18 * 512 = 1.44M (每个扇区512字节)
    3) 具体例子请参见./os-src/os15/
