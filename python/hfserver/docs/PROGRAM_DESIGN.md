# HotfixServer 程序设计文档

## 目标
提供内部开发环境使用的 HTTP 文件管理服务，支持上传、列表、下载与删除，并根据文件名分类到固定模式，执行保留策略。

## 模块结构
- `hotfix_server.py`：启动入口。
- `hotfixserver/`：后端模块（配置、日志、HTTP 处理、存储）。
- `static/`：前端页面与静态资源。
- `uploads/`：默认上传目录（运行时生成）。
- `scripts/`：启服/关服/重启/状态/日志脚本。
- `run.bat`/`run.sh`：跨平台统一运维入口。
- `docs/`：设计、使用与测试文档。

## 核心数据模型
`FileRecord`
- `name`：文件名
- `mode`：模式键（4 种之一）
- `uploaded_at`：UTC 时间戳
- `size`：文件大小

元数据持久化为 `uploads/.metadata.json`，用于列表与保留策略。配置文件为 `config.json`，支持全局与按模式保留策略。

## 模式判定
按文件名包含关系匹配（不区分大小写）：
- `h75na` + `hotfix`
- `h75na` + `server_hotfix`
- `h75` + `hotfix`
- `h75` + `server_hotfix`

## 保留策略
每个模式：
- 最多保留 `max_files_per_mode` 个文件（默认 20），支持在 `mode_limits` 中覆盖。
处理流程：上传完成后与列表请求时触发清理，按时间逆序保留前 N 个。

## 安全策略
- 删除接口 `DELETE /files/<name>` 仅允许 IP 白名单访问。
- 白名单通过 `config.json` 配置，默认仅本机 `127.0.0.1`/`::1`。

## 接口
- `POST /upload`：multipart 文件上传
- `GET /api/files`：按模式返回文件列表
- `GET /files/<name>`：下载
- `DELETE /files/<name>`：删除（白名单）
- `GET /health`：健康检查

## 运行时
服务器基于 `asyncio` 的 `start_server` 构建，采用异步处理请求与文件 I/O（通过 `asyncio.to_thread`）。

## 日志
控制台日志按级别输出不同颜色，启动时先输出字符 LOGO，再输出配置与监听信息。
日志同时写入 `log_file`（默认 `run/hotfix_server.log`）。
`config.json` 中可配置 `log_level`，并在运行中自动读取更新。

## 正式化改进建议
以下为面向正式项目的增强方向，按优先级分层：

### P0 稳定性与安全
- 鉴权与权限：上传/删除使用 API Key 或签名，IP 白名单仅作辅助。
- 上传校验：限制单文件大小、总请求大小、允许后缀/类型。
- 幂等上传：定义覆盖策略或版本化规则，避免无意覆盖。
- 审计日志：记录操作者标识、来源 IP、文件摘要、返回码。

### P1 可运维性
- 健康与就绪：增加 `/ready`，检查磁盘可写与空间阈值。
- 指标：暴露轻量 metrics（文件数、最新上传时间、响应时间）。
- 配置校验：启动时校验配置，清晰输出告警。
- 日志滚动：按天切分并自动清理。

### P1 数据与生命周期
- 版本与索引：按模式维护最新版本标识或 build id。
- 文件摘要：上传生成 SHA256，下载可校验。
- 归档策略：超限先归档到 `archive/` 再删除（可选）。

### P2 前端体验
- 搜索/过滤：按关键字、时间范围、大小筛选。
- 详情面板：显示大小、hash、上传者、时间、标签。
- 快速复制：一键复制下载链接。

### P2 测试与质量
- 自动化测试：覆盖上传/删除/列表/保留策略。
- 压测脚本：大文件与并发请求场景。

### P3 部署方式
- systemd 服务：Debian 下开机自启与日志管理。
- Windows 服务：后台运行与守护。
- 容器化：Dockerfile + volume 映射。

## 前端
单页应用，基于 `static/index.html` + `static/app.js`，按模式切换主题色并展示卡片列表。
